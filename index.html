<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Video en Realidad Aumentada con Efectos Gal√°cticos</title>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        .info {
            position: fixed;
            top: 0;
            width: 100%;
            background-color: rgba(0,0,0,0.7);
            color: white;
            text-align: center;
            z-index: 10;
            padding: 10px;
            font-family: Arial, sans-serif;
            font-size: clamp(14px, 4vw, 18px);
            box-sizing: border-box;
        }
        #play-button {
            position: fixed;
            bottom: 20%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            padding: 15px 30px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: clamp(16px, 5vw, 20px);
            cursor: pointer;
            min-width: 200px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        #debug-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            font-family: monospace;
            font-size: clamp(10px, 3vw, 12px);
            z-index: 100;
            max-height: 80px;
            overflow-y: auto;
            border-radius: 5px;
            max-width: 90%;
        }
        .mobile-controls-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 100;
            display: none;
            padding: 10px;
            box-sizing: border-box;
        }
        .mobile-control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        #video-selector {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border-radius: 5px;
            border: none;
            margin-bottom: 10px;
            background-color: #333;
            color: white;
        }
        .control-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 12px 24px;
            margin: 0 5px;
            cursor: pointer;
            min-width: 40px;
            font-size: 16px;
            flex-grow: 1;
        }
        #prev-video, #next-video {
            width: 48%;
            padding: 12px 5px;
        }
        #effect-toggle {
            background-color: #2196F3;
            width: 48%;
        }
        #effects-selector {
            width: 100%;
            padding: 12px;
            border-radius: 5px;
            border: none;
            background-color: #333;
            color: white;
            font-size: 16px;
        }
        .desktop-controls {
            display: none;
        }
        
        /* Media queries para dispositivos m√≥viles */
        @media (max-width: 768px) {
            .mobile-controls-container {
                padding-bottom: env(safe-area-inset-bottom, 10px);
            }
            #play-button {
                padding: 20px 30px;
                font-size: 18px;
            }
            .info {
                padding: 10px;
                padding-top: max(10px, env(safe-area-inset-top));
            }
            .control-button, #video-selector, #effects-selector {
                font-size: 16px;
                padding: 15px;
            }
        }
        
        /* Estilos para dispositivos muy peque√±os */
        @media (max-width: 375px) {
            .control-button {
                padding: 12px 5px;
            }
            .info {
                font-size: 14px;
            }
        }
        
        /* Soporte para notch en iPhones */
        @supports (padding-top: env(safe-area-inset-top)) {
            .info {
                padding-top: env(safe-area-inset-top);
            }
            .mobile-controls-container {
                padding-bottom: env(safe-area-inset-bottom, 10px);
            }
        }
        #marker-lost-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            font-size: 16px;
            text-align: center;
            z-index: 50;
            display: none;
            max-width: 80%;
        }
    #sound-toggle {
        background-color: #ff5722;
        width: 48%;
        margin-top: 10px;
    }
    </style>
</head>
<body>
    <div class="info">Muestra el marcador Hiro a la c√°mara para ver el video con efectos gal√°cticos</div>
    <button id="play-button">Iniciar AR y Video</button>
    <div id="debug-info"></div>
    <div id="marker-lost-message">Marcador perdido. Acerca el marcador a la c√°mara</div>
    
    <!-- Controles para m√≥viles (adaptados) -->
    <div class="mobile-controls-container" id="mobile-controls">
        <select id="video-selector">
            <option value="./video.mp4">Mi Video Local</option>
            <option value="./video2.mp4">Video Alternativo 1</option>
            <option value="./video3.mp4">Video Alternativo 2</option>
            <option value="./video4.mp4">Video Alternativo 3</option>
            <option value="./video5.mp4">Video Alternativo 4</option>
        </select>
        
        <div class="mobile-control-row">
            <button id="prev-video" class="control-button">&#9664; Anterior</button>
            <button id="next-video" class="control-button">Siguiente &#9654;</button>
        </div>
        
        <div class="mobile-control-row">
            <button id="effect-toggle" class="control-button">Efectos ON</button>
            <select id="effects-selector" class="control-button">
                <option value="saturn">Anillo de Saturno</option>
                <option value="stars">Estrellas Gal√°cticas</option>
            </select>
        </div>
    </div>
    
    <!-- Controles para desktop (originales) -->
    <div class="desktop-controls">
        <button id="effect-toggle-desktop">Desactivar Efecto</button>
        <select id="effects-selector-desktop">
            <option value="saturn">Estela de Saturno</option>
            <option value="stars">Estrellas Gal√°cticas</option>
        </select>
        <div id="video-controls-desktop">
            <select id="video-selector-desktop">
                <option value="./video.mp4">Mi Video Local</option>
                <option value="./video2.mp4">Video Alternativo 1</option>
                <option value="./video3.mp4">Video Alternativo 2</option>
                <option value="./video4.mp4">Video Alternativo 3</option>
                <option value="./video5.mp4">Video Alternativo 4</option>
            </select>
            <button id="prev-video-desktop" class="control-button">&lt;</button>
            <button id="next-video-desktop" class="control-button">&gt;</button>
            <button id="sound-toggle" class="control-button">üîá Sin sonido</button>
        </div>
    </div>
    
    <a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; sourceWidth: 1280; sourceHeight: 960;' vr-mode-ui="enabled: false" renderer="antialias: true; logarithmicDepthBuffer: true;">
        <a-assets>
            <video id="mivideo" crossorigin="anonymous" playsinline webkit-playsinline loop></video>
            <img id="star-texture" src="data:image/png;base64,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" />
        </a-assets>
        
        <a-marker preset="hiro" id="marker-hiro">
            <a-video 
                id="video-entity"
                src="#mivideo" 
                position="0 0.5 0" 
                rotation="-90 0 0" 
                width="0.1" 
                height="0.075"
                opacity="1">
            </a-video>
            
            <a-entity id="saturn-ring-container" position="0 0.49 0" rotation="-90 0 0">
                <a-torus 
                    id="saturn-ring" 
                    color="#bf40bf" 
                    radius="0.15" 
                    radius-tubular="0.01"
                    segments-tubular="32" 
                    segments-radial="32"
                    opacity="0.5"
                    material="shader: flat; transparent: true; side: double"
                    visible="false">
                </a-torus>
            </a-entity>
            
            <a-entity id="stars-container" position="0 0.49 0" rotation="-90 0 0" visible="false">
            </a-entity>
            
            <a-plane 
                id="video-glow"
                color="#00ffff" 
                position="0 0.49 0" 
                rotation="-90 0 0" 
                width="0.1" 
                height="0.075" 
                opacity="0.1"
                material="shader: flat; transparent: true; alphaTest: 0.01; depthTest: false; depthWrite: false; blending: additive">
            </a-plane>
        </a-marker>
        
        <a-entity camera></a-entity>
    </a-scene>
    
    <script>
        // Configuraci√≥n del entorno
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const isNetlify = window.location.hostname.includes('netlify.app');
        const baseUrl = isLocal ? window.location.origin + '/' : isNetlify ? window.location.origin + '/' : '/';
        // Referencias a elementos
        const playButton = document.getElementById('play-button');
        const video = document.getElementById('mivideo');
        const videoEntity = document.getElementById('video-entity');
        const videoGlow = document.getElementById('video-glow');
        const marker = document.querySelector('#marker-hiro');
        const infoDiv = document.querySelector('.info');
        const debugDiv = document.getElementById('debug-info');
        const mobileControls = document.getElementById('mobile-controls');
        const videoSelector = document.getElementById('video-selector');
        const prevVideoBtn = document.getElementById('prev-video');
        const nextVideoBtn = document.getElementById('next-video');
        const effectToggle = document.getElementById('effect-toggle');
        const effectsSelector = document.getElementById('effects-selector');
        const saturnRing = document.getElementById('saturn-ring');
        const saturnRingContainer = document.getElementById('saturn-ring-container');
        const starsContainer = document.getElementById('stars-container');
        const markerLostMessage = document.getElementById('marker-lost-message');
        const soundToggleBtn = document.getElementById('sound-toggle');

        let audioEnabled = false;
        // Estado del efecto
        let effectEnabled = true;
        let currentEffect = 'saturn';
        // Array de videos disponibles
        const videos = Array.from(videoSelector.options).map(option => option.value);
        let currentVideoIndex = 0;
        // Variables para la animaci√≥n
        let expansionAnimation = null;
        let startTime = null;
        let initialWidth = 0.1;
        let initialHeight = 0.075;
        let targetWidth = 3;
        let targetHeight = 2.25;
        const animationDuration = 1500;
        // Variables para efectos especiales
        let ringExpansionAnimation = null;
        let ringStartTime = null;
        let stars = [];
        let maxStars = 50;
        // Variable para controlar si el video ya se expandi√≥
        let videoExpanded = false;
        // Tiempo para mostrar y ocultar mensajes de marcador perdido
        let markerLostTimeout = null;
        // Detectar dispositivo m√≥vil
        const isMobileDevice = () => {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                (typeof window.orientation !== "undefined") || 
                window.innerWidth <= 768;
        };
        // Ajustar tama√±os seg√∫n el dispositivo
        function setupDimensions() {
            if (isMobileDevice()) {
                // Dimensiones para m√≥viles - m√°s grandes que en el c√≥digo original
                initialWidth = 0.1;
                initialHeight = 0.075;
                targetWidth = 2.0;  // M√°s grande para m√≥viles
                targetHeight = 1.5; // M√°s grande para m√≥viles
                maxStars = 30; // Menos estrellas en m√≥viles para mejor rendimiento
                
                showDebugInfo('üì± Usando dimensiones para m√≥vil');
            } else {
                // Dimensiones para escritorio
                initialWidth = 0.1;
                initialHeight = 0.075;
                targetWidth = 3;
                targetHeight = 2.25;
                maxStars = 50;
                
                showDebugInfo('üíª Usando dimensiones para escritorio');
            }
            
            // Aplicar dimensiones iniciales (solo si no est√° expandido)
            if (!videoExpanded) {
                videoEntity.setAttribute('width', initialWidth);
                videoEntity.setAttribute('height', initialHeight);
                videoGlow.setAttribute('width', initialWidth);
                videoGlow.setAttribute('height', initialHeight);
            }
        }
        //MANEJAR EL SONIDO
        function toggleSound() {
        // Cambiar el estado del audio
            audioEnabled = !audioEnabled;
            
            if (audioEnabled) {
                // Habilitar audio
                video.muted = false;
                soundToggleBtn.textContent = 'üîä Con sonido';
                soundToggleBtn.style.backgroundColor = '#4CAF50';
                showDebugInfo('üîä Audio habilitado');
            } else {
                // Deshabilitar audio
                video.muted = true;
                soundToggleBtn.textContent = 'üîá Sin sonido';
                soundToggleBtn.style.backgroundColor = '#ff5722';
                showDebugInfo('üîá Audio deshabilitado');
            }
        }
        soundToggleBtn.addEventListener('click', () => {
            // En m√≥viles, el primer clic debe ser un gesto de usuario para permitir la reproducci√≥n con audio
            if (!audioEnabled && !video.paused) {
                toggleSound();
            } else if (!audioEnabled) {
                // Si el video est√° pausado, activar el sonido cuando se reproduzca
                video.muted = false;
                audioEnabled = true;
                soundToggleBtn.textContent = 'üîä Con sonido';
                soundToggleBtn.style.backgroundColor = '#4CAF50';
                showDebugInfo('üîä Audio habilitado - se reproducir√° cuando inicie el video');
            } else {
                toggleSound();
            }
        });
        // Configurar controles seg√∫n el dispositivo
        function setupControls() {
            if (isMobileDevice()) {
                showDebugInfo('üì± Configurando controles para m√≥vil');
                document.querySelector('.desktop-controls').style.display = 'none';
                effectToggle.textContent = effectEnabled ? 'Efectos ON' : 'Efectos OFF';
            } else {
                showDebugInfo('üíª Configurando controles para escritorio');
                document.querySelector('.desktop-controls').style.display = 'block';
                effectToggle.textContent = effectEnabled ? 'Desactivar Efecto' : 'Activar Efecto';
            }
        }
        // Funci√≥n para mostrar informaci√≥n de depuraci√≥n
        function showDebugInfo(msg) {
            debugDiv.innerHTML += msg + '<br>';
            console.log(msg);
            const lines = debugDiv.innerHTML.split('<br>');
            if (lines.length > 5) {
                debugDiv.innerHTML = lines.slice(lines.length - 5).join('<br>');
            }
        }
        // Funci√≥n para animar la expansi√≥n usando requestAnimationFrame
        function animateExpansion(timestamp) {
            if (!startTime) startTime = timestamp;
            var elapsedTime = timestamp - startTime;
            
            if (elapsedTime < animationDuration) {
                var progress = elapsedTime / animationDuration;
                var easedProgress = progress * (2 - progress);
                
                var currentWidth = initialWidth + (targetWidth - initialWidth) * easedProgress;
                var currentHeight = initialHeight + (targetHeight - initialHeight) * easedProgress;
                
                // Mantener la opacidad en 1 durante toda la animaci√≥n
                videoEntity.setAttribute('width', currentWidth);
                videoEntity.setAttribute('height', currentHeight);
                videoEntity.setAttribute('opacity', 1);
                
                // Reducir la opacidad del efecto de brillo
                videoGlow.setAttribute('width', currentWidth);
                videoGlow.setAttribute('height', currentHeight);
                videoGlow.setAttribute('opacity', 0.1);
                
                expansionAnimation = requestAnimationFrame(animateExpansion);
            } else {
                videoEntity.setAttribute('width', targetWidth);
                videoEntity.setAttribute('height', targetHeight);
                videoEntity.setAttribute('opacity', 1);
                videoGlow.setAttribute('width', targetWidth);
                videoGlow.setAttribute('height', targetHeight);
                videoGlow.setAttribute('opacity', 0.1);
                
                expansionAnimation = null;
                startTime = null;
                
                // Marcar que el video se ha expandido
                videoExpanded = true;
                
                showDebugInfo('‚úÖ Animaci√≥n de expansi√≥n completada');
                
                // Guardar estado expandido en localStorage
                try {
                    localStorage.setItem('videoExpanded', 'true');
                    localStorage.setItem('videoWidth', targetWidth);
                    localStorage.setItem('videoHeight', targetHeight);
                } catch (e) {
                    console.error('Error al guardar en localStorage:', e);
                }
                
                if (currentEffect === 'saturn') {
                    animateSaturnRing();
                } else if (currentEffect === 'stars') {
                    createStars();
                }
            }
        }
        // Funci√≥n para animar el anillo de Saturno
        function animateSaturnRing() {
            if (!effectEnabled) return;
            
            // Ocultar las estrellas si estaban visibles
            starsContainer.setAttribute('visible', false);
            removeAllStars();
            
            // Mostrar el anillo de Saturno
            saturnRing.setAttribute('visible', true);
            saturnRingContainer.setAttribute('visible', true);
            
            // Configurar tama√±o inicial del anillo (ajustar seg√∫n necesidad)
            saturnRing.setAttribute('radius', 0.5);
            saturnRing.setAttribute('opacity', 0.8);
            
            // Iniciar la animaci√≥n de expansi√≥n del anillo
            ringStartTime = null;
            ringExpansionAnimation = requestAnimationFrame(animateRingExpansion);
            
            showDebugInfo('ü™ê Efecto de Anillo de Saturno activado');
        }
        // Funci√≥n para animar la expansi√≥n del anillo
        function animateRingExpansion(timestamp) {
            if (!ringStartTime) ringStartTime = timestamp;
            var elapsedTime = timestamp - ringStartTime;
            var explosionDuration = 3000; // 3 segundos
            
            if (elapsedTime < explosionDuration) {
                // Calculamos el progreso de la animaci√≥n (0 a 1)
                var progress = elapsedTime / explosionDuration;
                
                // Funci√≥n de easing para una expansi√≥n r√°pida al inicio y luego m√°s lenta
                var easedProgress = Math.pow(progress, 0.5);
                
                // Aumentamos el radio y disminuimos la opacidad
                var currentRadius = 0.5 + 2.5 * easedProgress; // De 0.5 a 3.0
                var currentOpacity = 0.8 - 0.8 * easedProgress; // De 0.8 a 0
                
                // Colores del anillo cambiantes
                var hue = 270 + 180 * easedProgress; // De morado a cian
                var currentColor = `hsl(${hue}, 100%, 60%)`;
                
                // Aplicar cambios
                saturnRing.setAttribute('radius', currentRadius);
                saturnRing.setAttribute('opacity', currentOpacity);
                saturnRing.setAttribute('color', currentColor);
                
                // Animar tambi√©n el grosor del tubo
                var currentTube = 0.01 + 0.04 * easedProgress;
                saturnRing.setAttribute('radius-tubular', currentTube);
                
                // Continuar animaci√≥n
                ringExpansionAnimation = requestAnimationFrame(animateRingExpansion);
            } else {
                // Ocultar el anillo al terminar
                saturnRing.setAttribute('visible', false);
                
                // Detener animaci√≥n
                ringExpansionAnimation = null;
                ringStartTime = null;
                
                showDebugInfo('‚ú® Explosi√≥n gal√°ctica completada');
            }
        }
        // Funci√≥n para crear estrellas alrededor del video
        function createStars() {
            if (!effectEnabled) return;
            
            // Ocultar anillo de Saturno
            saturnRing.setAttribute('visible', false);
            saturnRingContainer.setAttribute('visible', false);
            
            // Mostrar contenedor de estrellas
            starsContainer.setAttribute('visible', true);
            
            // Limpiar estrellas anteriores
            removeAllStars();
            
            // Obtener dimensiones actuales del video
            var videoWidth = parseFloat(videoEntity.getAttribute('width'));
            var videoHeight = parseFloat(videoEntity.getAttribute('height'));
            
            // Crear nuevas estrellas
            for (let i = 0; i < maxStars; i++) {
                // Crear una estrella
                var star = document.createElement('a-image');
                
                // Posiciones aleatorias alrededor del video
                // √Årea m√°s amplia alrededor del video
                var offsetX = (Math.random() * 2 - 1) * (videoWidth + 0.5);
                var offsetY = (Math.random() * 2 - 1) * (videoHeight + 0.5);
                var offsetZ = Math.random() * 0.5 - 0.25;
                
                // Evitar poner estrellas sobre el video
                if (Math.abs(offsetX) < videoWidth/2 && Math.abs(offsetY) < videoHeight/2) {
                    // Si est√° dentro del video, moverla a los bordes
                    var moveToEdge = Math.random() < 0.5 ? videoWidth/2 + 0.1 : -videoWidth/2 - 0.1;
                    if (Math.random() < 0.5) {
                        offsetX = moveToEdge;
                    } else {
                        offsetY = moveToEdge;
                    }
                }
                
                // Configurar propiedades de la estrella
                star.setAttribute('src', '#star-texture');
                star.setAttribute('position', {x: offsetX, y: offsetY, z: offsetZ});
                
                // Tama√±os aleatorios
                var size = Math.random() * 0.15 + 0.05;
                star.setAttribute('width', size);
                star.setAttribute('height', size);
                
                // Opacidad aleatoria
                star.setAttribute('opacity', Math.random() * 0.8 + 0.2);
                
                // Colores aleatorios
                var hues = [200, 220, 240, 260, 280, 300, 320]; // Azules, morados, rosas
                var hue = hues[Math.floor(Math.random() * hues.length)];
                var saturation = Math.floor(Math.random() * 30 + 70); // 70-100%
                var lightness = Math.floor(Math.random() * 30 + 50); // 50-80%
                star.setAttribute('color', `hsl(${hue}, ${saturation}%, ${lightness}%)`);
                
                // Material brillante
                star.setAttribute('material', 'shader: flat; transparent: true; alphaTest: 0.1; depthTest: false; depthWrite: false; blending: additive');
                
                // Agregar al contenedor
                starsContainer.appendChild(star);
                
                // Guardar referencia
                stars.push(star);
                
                // Animar la estrella
                animateStar(star);
            }
            
            showDebugInfo('‚ú® Efecto de estrellas gal√°cticas activado');
        }
        // Funci√≥n para animar una estrella
        function animateStar(star) {
            // Duraci√≥n aleatoria entre 2 y 5 segundos
            var duration = Math.random() * 3000 + 2000;
            
            // Detectar si el navegador soporta Web Animations API
            if (typeof star.animate === 'function') {
                // Usando Web Animations API para mejores efectos
                var twinkle = star.animate([
                    { opacity: star.getAttribute('opacity'), transform: 'scale(1)' },
                    { opacity: 0.1, transform: 'scale(0.8)' },
                    { opacity: star.getAttribute('opacity'), transform: 'scale(1.2)' },
                    { opacity: 0.2, transform: 'scale(0.9)' },
                    { opacity: star.getAttribute('opacity'), transform: 'scale(1)' }
                ], {
                    duration: duration,
                    iterations: Infinity,
                    easing: 'ease-in-out'
                });
            } else {
                // Fallback para navegadores sin Web Animations API
                var startOpacity = parseFloat(star.getAttribute('opacity'));
                var startScale = 1.0;
                var startTime = null;
                
                // Funci√≥n b√°sica de animaci√≥n
                function animateStarFallback(timestamp) {
                    if (!startTime) startTime = timestamp;
                    var elapsedTime = (timestamp - startTime) % duration;
                    var progress = elapsedTime / duration;
                    
                    // Ciclo de parpadeo simple
                    var opacity = startOpacity * (0.5 + 0.5 * Math.sin(progress * Math.PI * 2));
                    var scale = startScale * (0.8 + 0.4 * Math.sin(progress * Math.PI * 2));
                    
                    star.setAttribute('opacity', opacity);
                    star.setAttribute('scale', `${scale} ${scale} ${scale}`);
                    
                    requestAnimationFrame(animateStarFallback);
                }
                
                requestAnimationFrame(animateStarFallback);
            }
        }
        // Funci√≥n para eliminar todas las estrellas
        function removeAllStars() {
            stars.forEach(star => {
                if (star.parentNode) {
                    star.parentNode.removeChild(star);
                }
            });
            stars = [];
        }
        // Funci√≥n para cambiar de video
        function changeVideo(direction) {
            if (direction === 'next') {
                currentVideoIndex = (currentVideoIndex + 1) % videos.length;
            } else if (direction === 'prev') {
                currentVideoIndex = (currentVideoIndex - 1 + videos.length) % videos.length;
            } else {
                // Si se proporciona un √≠ndice directo
                currentVideoIndex = parseInt(direction);
            }
            
            const videoPath = videos[currentVideoIndex];
            videoSelector.value = videoPath;
            
            loadVideo(videoPath);
            showDebugInfo(`üé¨ Cambiando a video: ${videoPath}`);
        }
        // Funci√≥n para cargar un video
        function loadVideo(videoPath) {
            // Detener reproducciones previas
            video.pause();
            
            // Guardar el estado actual del audio
            const wasMuted = video.muted;
            
            // Usar la ruta base para cargar videos
            const fullPath = videoPath.startsWith('./') ? 
                baseUrl + videoPath.substring(2) : videoPath;
            
            video.src = fullPath;
            video.load();
            
            // Reproducir despu√©s de cargar
            video.oncanplaythrough = function() {
                // Restaurar el estado del audio
                video.muted = wasMuted;
                
                video.play()
                    .then(() => {
                        showDebugInfo(`‚ñ∂Ô∏è Video reproduciendo: ${fullPath}`);
                    })
                    .catch(err => {
                        showDebugInfo(`‚ùå Error al reproducir video: ${err.message}`);
                        // Si hay error de permisos de reproducci√≥n, intentar con muted
                        if (err.name === "NotAllowedError") {
                            showDebugInfo('‚ö†Ô∏è Requiere interacci√≥n: intentando con audio silenciado');
                            video.muted = true;
                            video.play().catch(e => {
                                showDebugInfo(`‚ùå Error persistente: ${e.message}`);
                            });
                        }
                    });
            };
            
            video.onerror = function() {
                showDebugInfo(`‚ùå Error al cargar video: ${fullPath}`);
                infoDiv.innerHTML = "Error al cargar el video, verifica la ruta";
            };
        }
        // Funci√≥n para alternar efectos
        function toggleEffect() {
            effectEnabled = !effectEnabled;
            
            if (effectEnabled) {
                effectToggle.textContent = isMobileDevice() ? 'Efectos ON' : 'Desactivar Efecto';
                effectToggle.style.backgroundColor = '#2196F3';
                
                // Activar efecto actual
                if (currentEffect === 'saturn') {
                    animateSaturnRing();
                } else if (currentEffect === 'stars') {
                    createStars();
                }
                
                showDebugInfo('‚úÖ Efectos activados');
            } else {
                effectToggle.textContent = isMobileDevice() ? 'Efectos OFF' : 'Activar Efecto';
                effectToggle.style.backgroundColor = '#f44336';
                
                // Ocultar todos los efectos
                saturnRing.setAttribute('visible', false);
                starsContainer.setAttribute('visible', false);
                removeAllStars();
                
                // Detener animaciones
                if (ringExpansionAnimation) {
                    cancelAnimationFrame(ringExpansionAnimation);
                    ringExpansionAnimation = null;
                }
                
                showDebugInfo('‚ùå Efectos desactivados');
            }
        }
        // Funci√≥n para cambiar el tipo de efecto
        function changeEffect(effect) {
            currentEffect = effect;
            
            // Actualizar el selector en la interfaz
            effectsSelector.value = effect;
            
            // Si los efectos est√°n activados, cambiar inmediatamente
            if (effectEnabled) {
                if (effect === 'saturn') {
                    animateSaturnRing();
                } else if (effect === 'stars') {
                    createStars();
                }
            }
            
            showDebugInfo(`üåå Efecto cambiado a: ${effect}`);
        }
        // Funci√≥n para iniciar la experiencia AR
        function startARExperience() {
            // Ocultar bot√≥n de inicio
            playButton.style.display = 'none';
            
            // Actualizar mensaje informativo
            infoDiv.innerHTML = "Escaneando marcador Hiro...";
            
            // Mostrar controles si es un dispositivo m√≥vil
            if (isMobileDevice()) {
                mobileControls.style.display = 'block';
            }
            
            // Intentar iniciar el video
            loadVideo(videos[currentVideoIndex]);
            
            // Verificar si ya hay un estado guardado en localStorage
            try {
                if (localStorage.getItem('videoExpanded') === 'true') {
                    videoExpanded = true;
                    const savedWidth = parseFloat(localStorage.getItem('videoWidth')) || targetWidth;
                    const savedHeight = parseFloat(localStorage.getItem('videoHeight')) || targetHeight;
                    
                    // Aplicar dimensiones guardadas
                    videoEntity.setAttribute('width', savedWidth);
                    videoEntity.setAttribute('height', savedHeight);
                    videoGlow.setAttribute('width', savedWidth);
                    videoGlow.setAttribute('height', savedHeight);
                    
                    showDebugInfo('üîÑ Restaurando estado guardado del video');
                }
            } catch (e) {
                console.error('Error al acceder a localStorage:', e);
            }
            
            showDebugInfo('üöÄ Iniciando experiencia AR');
        }
        // Funci√≥n para manejar la detecci√≥n del marcador
        function handleMarkerFound() {
            infoDiv.innerHTML = "¬°Marcador detectado! Reproduciendo video con efectos";
            
            // Ocultar mensaje de marcador perdido si estaba visible
            markerLostMessage.style.display = 'none';
            
            // Limpiar cualquier timeout anterior
            if (markerLostTimeout) {
                clearTimeout(markerLostTimeout);
                markerLostTimeout = null;
            }
            
            // Verificar si el video est√° en su tama√±o expandido o si necesita expandirse
            const currentVideoWidth = parseFloat(videoEntity.getAttribute('width'));
            
            // Solo iniciar la animaci√≥n si el video no est√° ya expandido
            if (currentVideoWidth < targetWidth && !expansionAnimation) {
                // Si no est√° completamente expandido, iniciamos la animaci√≥n
                startTime = null;
                expansionAnimation = requestAnimationFrame(animateExpansion);
                showDebugInfo('üîç Marcador detectado, iniciando animaci√≥n de expansi√≥n');
            } else if (currentVideoWidth >= targetWidth) {
                // Si ya est√° expandido, asegurarnos de mantener ese tama√±o
                showDebugInfo('üîç Marcador detectado, manteniendo tama√±o expandido');
                
                // Asegurarse de que los efectos est√©n activos si est√°n habilitados
                if (effectEnabled) {
                    if (currentEffect === 'saturn') {
                        // Solo iniciar el efecto de Saturno si no est√° ya en ejecuci√≥n
                        if (!ringExpansionAnimation) animateSaturnRing();
                    } else if (currentEffect === 'stars') {
                        // Refrescar efecto de estrellas si est√° habilitado
                        if (stars.length === 0) createStars();
                    }
                }
            }
            
            // Asegurarse de que el video se est√© reproduciendo
            if (video.paused) {
                video.play().catch(err => {
                    showDebugInfo(`‚ùå Error al reanudar video: ${err.message}`);
                });
            }
        }
        // Funci√≥n para manejar la p√©rdida del marcador
        function handleMarkerLost() {
            infoDiv.innerHTML = "Marcador perdido. Acerca el marcador a la c√°mara";
            
            showDebugInfo('‚ö†Ô∏è Marcador perdido');
            
            // Mostrar mensaje de marcador perdido despu√©s de un breve retraso
            if (markerLostTimeout) clearTimeout(markerLostTimeout);
            
            markerLostTimeout = setTimeout(() => {
                markerLostMessage.style.display = 'block';
            }, 1500); // Mostrar despu√©s de 1.5 segundos para evitar parpadeos
            
            // Ya no reducimos el tama√±o del video al perder el marcador
            // Simplemente mantenemos el tama√±o actual para que permanezca expandido
            
            // Opcional: Pausar video cuando se pierde el marcador
            // video.pause();
        }
        // Funci√≥n para cargar estado guardado
        function loadSavedState() {
            try {
                // Verificar si hay estado guardado
                if (localStorage.getItem('videoExpanded') === 'true') {
                    videoExpanded = true;
                    const savedWidth = parseFloat(localStorage.getItem('videoWidth')) || targetWidth;
                    const savedHeight = parseFloat(localStorage.getItem('videoHeight')) || targetHeight;
                    
                    // Aplicar dimensiones guardadas
                    videoEntity.setAttribute('width', savedWidth);
                    videoEntity.setAttribute('height', savedHeight);
                    videoGlow.setAttribute('width', savedWidth);
                    videoGlow.setAttribute('height', savedHeight);
                    
                    showDebugInfo('üîÑ Estado del video restaurado desde localStorage');
                }
            } catch (e) {
                console.error('Error al cargar estado desde localStorage:', e);
            }
        }
        // Configurar evento para el bot√≥n de inicio
        playButton.addEventListener('click', startARExperience);
        // Configurar eventos para controles m√≥viles
        prevVideoBtn.addEventListener('click', () => changeVideo('prev'));
        nextVideoBtn.addEventListener('click', () => changeVideo('next'));
        effectToggle.addEventListener('click', toggleEffect);
        effectsSelector.addEventListener('change', (e) => changeEffect(e.target.value));
        videoSelector.addEventListener('change', (e) => {
            const newVideoPath = e.target.value;
            loadVideo(newVideoPath);
            
            // Actualizar el √≠ndice actual
            currentVideoIndex = videos.indexOf(newVideoPath);
            if (currentVideoIndex === -1) currentVideoIndex = 0;
            
            // Al cambiar de video, mantener el tama√±o expandido si ya estaba expandido
            if (videoExpanded) {
                // Si estaba expandido, aplicar inmediatamente el tama√±o expandido al nuevo video
                setTimeout(() => {
                    videoEntity.setAttribute('width', targetWidth);
                    videoEntity.setAttribute('height', targetHeight);
                    videoGlow.setAttribute('width', targetWidth);
                    videoGlow.setAttribute('height', targetHeight);
                    showDebugInfo('üé¨ Nuevo video manteniendo tama√±o expandido');
                }, 100);
            }
        });
        // Configurar eventos para detectar el marcador
        marker.addEventListener('markerFound', handleMarkerFound);
        marker.addEventListener('markerLost', handleMarkerLost);
        // Manejar clic en el mensaje de marcador perdido para ocultarlo
        markerLostMessage.addEventListener('click', () => {
            markerLostMessage.style.display = 'none';
        });
        // Inicializar dimensiones y controles
        window.addEventListener('load', () => {
            setupDimensions();
            setupControls();
            loadSavedState();
            showDebugInfo('üåü Aplicaci√≥n AR inicializada');
        });
        // Manejar cambios de orientaci√≥n en dispositivos m√≥viles
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                setupDimensions();
                showDebugInfo('üì± Orientaci√≥n cambiada, ajustando dimensiones');
            }, 300);
        });
        // Manejar cambios de tama√±o de ventana
        window.addEventListener('resize', () => {
            clearTimeout(window.resizeTimer);
            window.resizeTimer = setTimeout(() => {
                setupDimensions();
                showDebugInfo('üñ•Ô∏è Tama√±o de ventana cambiado, ajustando dimensiones');
            }, 250);
        });
        // Mensaje inicial de console
        console.log('Video en Realidad Aumentada con Efectos Gal√°cticos v1.1');
    </script>
</body>
</html>